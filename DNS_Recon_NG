#!/bin/bash

# ------------------------------
# Ferramenta de Recon DNS Avançado com Evasão
# Autor: ChatGPT CyberSec Mode
# Descrição: Consulta IPs em fontes passivas para extrair domínios associados.
# Recursos adicionais: suporte a proxy e delays randômicos para evasão
# ------------------------------

# IPs alvo (adicione mais conforme necessidade)
IPS=(
  "8.8.8.8"         # Google Public DNS
  "1.1.1.1"         # Cloudflare DNS
  "208.67.222.222"  # OpenDNS
  "13.107.21.200"   # Microsoft Azure
  "104.244.42.1"    # Twitter CDN
  "151.101.1.69"    # GitHub Pages
  "185.199.108.153" # GitHub raw
  "23.216.10.70"    # Akamai CDN
  "216.58.222.46"   # Google
  "34.194.216.183"  # AWS EC2
)

# Suas chaves de API
SECURITYTRAILS_API="SUA_CHAVE_SECURITYTRAILS"
VT_API="SUA_CHAVE_VIRUSTOTAL"

# Configuração de proxy (opcional)
USE_PROXY=true
PROXY="http://127.0.0.1:9050"  # Exemplo com Tor (porta 9050)

# Define delay aleatório entre requisições (em segundos)
random_delay() {
  DELAY=$(( (RANDOM % 5) + 1 ))
  sleep $DELAY
}

# Verifica dependências
check_dependencies() {
  for bin in curl jq; do
    if ! command -v $bin >/dev/null 2>&1; then
      echo "[!] Dependência ausente: $bin"
      echo "[+] Instalando $bin..."
      sudo apt install -y $bin || sudo yum install -y $bin
    fi
  done
}

# Função de curl com ou sem proxy
c_request() {
  local url="$1"
  local headers="$2"
  if [ "$USE_PROXY" = true ]; then
    curl -s --proxy "$PROXY" $headers "$url"
  else
    curl -s $headers "$url"
  fi
}

# Hackertarget
consulta_hackertarget() {
  echo "[Hackertarget] Subdomínios para $1"
  c_request "https://api.hackertarget.com/reverseiplookup/?q=$1" ""
  echo
  random_delay
}

# SecurityTrails
consulta_securitytrails() {
  echo "[SecurityTrails] Domínios históricos para $1"
  local data="{\"filter\":{\"ipv4\":\"$1\"}}"
  c_request "https://api.securitytrails.com/v1/search/list" \
    "-H \"apikey: $SECURITYTRAILS_API\" -H \"Content-Type: application/json\" -d '$data'" | \
    jq -r '.records[].hostname' || echo "Nenhum resultado."
  echo
  random_delay
}

# VirusTotal
consulta_virustotal() {
  echo "[VirusTotal] Domínios e certs SSL para $1"
  c_request "https://www.virustotal.com/api/v3/ip_addresses/$1" \
    "-H \"x-apikey: $VT_API\"" | \
    jq -r '.data.attributes.last_https_certificate.extensions.subject_alternative_name[]?' || echo "Nenhum resultado."
  echo
  random_delay
}

# Execução principal
main() {
  check_dependencies
  for ip in "${IPS[@]}"; do
    echo "=============================="
    echo "Analisando IP: $ip"
    consulta_hackertarget "$ip"
    consulta_securitytrails "$ip"
    consulta_virustotal "$ip"
    echo "=============================="
  done
}

main
